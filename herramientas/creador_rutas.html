<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas VFR | MiWebMSFS20</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* (Tus estilos se mantienen igual) */
        body { background-color: #121418; color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #1e222d; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        h1 { color: #fff; border-bottom: 2px solid #333; padding-bottom: 15px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        h1 i { color: #4a90e2; }
        h2 { color: #aaa; font-size: 1.1rem; margin-top: 25px; border-left: 4px solid #4a90e2; padding-left: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 0.9rem; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        #lista-tramos { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .tramo-item { background: #252a36; padding: 15px; border-radius: 6px; border-left: 5px solid #555; display: flex; justify-content: space-between; align-items: center; }
        .tramo-item.DESPEGUE { border-left-color: #ff9800; }
        .tramo-item.ATERRIZAJE { border-left-color: #4caf50; }
        .tramo-item.CRUCERO { border-left-color: #4a90e2; }
        .tramo-info strong { color: #fff; font-size: 1.1rem; }
        .tramo-detalles { font-size: 0.85rem; color: #aaa; margin-top: 5px; }
        .tramo-detalles span { margin-right: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .btn-add { background: #333; color: #fff; width: 100%; border: 2px dashed #444; }
        .btn-save { background: linear-gradient(to right, #2ecc71, #27ae60); color: #fff; width: 100%; margin-top: 30px; }
        .btn-delete { background: none; color: #e74c3c; font-size: 1.2rem; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #1e222d; width: 90%; max-width: 500px; padding: 25px; border-radius: 10px; border: 1px solid #444; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-route"></i> Planificador de Rutas VFR</h1>

        <div style="background: rgba(74, 144, 226, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px dashed #4a90e2;">
            <label style="color: #4a90e2; margin-bottom: 10px;"><i class="fas fa-folder-open"></i> Seleccionar ruta de la biblioteca:</label>
            <div style="display: flex; gap: 10px;">
                <select id="selector-rutas" style="flex-grow: 1;">
                    <option value="">Cargando rutas...</option>
                </select>
                <button class="btn" onclick="cargarRutaSeleccionada()" style="background: #4a90e2; color: white;">
                    EDITAR
                </button>
            </div>
        </div>

        <section>
            <h2><i class="fas fa-info-circle"></i> Datos Generales</h2>
            <div class="form-group">
                <label>Nombre de la Ruta</label>
                <input type="text" id="meta-nombre">
            </div>
            <div class="row">
                <div class="col form-group">
                    <label>Fecha</label>
                    <input type="date" id="meta-fecha">
                </div>
                <div class="col form-group">
                    <label>Hora Salida</label>
                    <input type="time" id="meta-hora" value="10:00">
                </div>
            </div>
            <div class="form-group">
                <label>Meteorolog√≠a (METAR)</label>
                <input type="text" id="meta-meteo">
            </div>
        </section>

        <section>
            <h2><i class="fas fa-map-marker-alt"></i> Tramos de Navegaci√≥n</h2>
            <div id="lista-tramos">
                <p style="text-align:center; color:#555; font-style:italic; padding: 20px;">No hay tramos a√±adidos.</p>
            </div>
            <button class="btn btn-add" onclick="abrirModal()"><i class="fas fa-plus"></i> A√±adir Tramo</button>
        </section>

        <button class="btn btn-save" onclick="generarJSON()"><i class="fas fa-file-download"></i> DESCARGAR ARCHIVO ACTUALIZADO (.JSON)</button>
    </div>

    <div class="modal-overlay" id="modal-tramo">
        <div class="modal-content">
            <h3 style="color:#fff;">Nuevo Tramo</h3>
            <div class="form-group">
                <label>Tipo</label>
                <select id="t-tipo">
                    <option value="CRUCERO">‚úàÔ∏è CRUCERO</option>
                    <option value="DESPEGUE">üõ´ DESPEGUE</option>
                    <option value="ATERRIZAJE">üõ¨ ATERRIZAJE</option>
                </select>
            </div>
            <div class="row">
                <div class="col form-group"><label>Desde</label><input type="text" id="t-inicio"></div>
                <div class="col form-group"><label>Hasta</label><input type="text" id="t-fin"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>Rumbo</label><input type="text" id="t-rumbo"></div>
                <div class="col form-group"><label>Altitud</label><input type="text" id="t-altitud"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>Velocidad</label><input type="text" id="t-velocidad"></div>
                <div class="col form-group"><label>Tiempo</label><input type="text" id="t-tiempo"></div>
            </div>
            <div class="form-group"><label>Notas</label><input type="text" id="t-instruccion"></div>
            <div class="modal-footer">
                <button class="btn" style="background:#444;" onclick="cerrarModal()">Cancelar</button>
                <button class="btn" style="background:#4a90e2;" onclick="guardarTramo()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        let tramos = [];

        // --- 1. CARGAR EL √çNDICE DE RUTAS AL INICIAR ---
        window.onload = async function() {
            const selector = document.getElementById('selector-rutas');
            try {
                // Buscamos tu archivo de √≠ndice
                const res = await fetch('data/rutas_usuario.json');
                if (!res.ok) throw new Error();
                const data = await res.json();
                
                selector.innerHTML = '<option value="">-- Elige una ruta para editar --</option>';
                data.rutas.forEach(ruta => {
                    let option = document.createElement('option');
                    option.value = ruta.archivo; // ej: "data/rutas/vigo_santiago.json"
                    option.textContent = ruta.nombre;
                    selector.appendChild(option);
                });
            } catch (err) {
                selector.innerHTML = '<option value="">Error cargando rutas_usuario.json</option>';
            }
        };

        // --- 2. CARGAR LA RUTA SELECCIONADA ---
        async function cargarRutaSeleccionada() {
            const archivo = document.getElementById('selector-rutas').value;
            if (!archivo) return alert("Selecciona una ruta primero.");

            try {
                const res = await fetch(archivo);
                const datos = await res.json();
                
                // Rellenar cabecera
                document.getElementById('meta-nombre').value = datos.meta.nombre || "";
                document.getElementById('meta-fecha').value = datos.meta.fecha || "";
                document.getElementById('meta-hora').value = datos.meta.hora_estimada || "";
                document.getElementById('meta-meteo').value = datos.meta.meteo_prevista || "";
                
                // Cargar tramos
                tramos = datos.tramos || [];
                renderizarTramos();
                
                alert("Ruta cargada. Ahora puedes modificarla.");
            } catch (err) {
                alert("Error al abrir el archivo de la ruta.");
            }
        }

        // --- (Funciones de soporte: abrirModal, cerrarModal, guardarTramo, renderizarTramos, generarJSON) ---
        // Estas funciones son id√©nticas a las anteriores para manejar la l√≥gica de la tabla.
        function abrirModal() { document.getElementById('modal-tramo').classList.add('active'); }
        function cerrarModal() { document.getElementById('modal-tramo').classList.remove('active'); }
        function guardarTramo() {
            tramos.push({
                tipo: document.getElementById('t-tipo').value,
                punto_inicio: document.getElementById('t-inicio').value,
                punto_fin: document.getElementById('t-fin').value,
                rumbo: document.getElementById('t-rumbo').value,
                altitud: document.getElementById('t-altitud').value,
                velocidad: document.getElementById('t-velocidad').value,
                tiempo: document.getElementById('t-tiempo').value,
                instruccion: document.getElementById('t-instruccion').value
            });
            renderizarTramos(); cerrarModal();
        }
        function renderizarTramos() {
            const contenedor = document.getElementById('lista-tramos');
            contenedor.innerHTML = tramos.length ? '' : '<p style="text-align:center; color:#555; padding: 20px;">No hay tramos.</p>';
            tramos.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = `tramo-item ${t.tipo}`;
                div.innerHTML = `<div><strong>${t.punto_inicio} &rarr; ${t.punto_fin}</strong><div class="tramo-detalles"><span><i class="fas fa-compass"></i> ${t.rumbo}</span><span><i class="fas fa-arrows-alt-v"></i> ${t.altitud}</span></div></div><button class="btn-delete" onclick="tramos.splice(${i},1);renderizarTramos();"><i class="fas fa-times"></i></button>`;
                contenedor.appendChild(div);
            });
        }
        function generarJSON() {
            const blob = new Blob([JSON.stringify({ meta: { nombre: document.getElementById('meta-nombre').value, fecha: document.getElementById('meta-fecha').value, hora_estimada: document.getElementById('meta-hora').value, meteo_prevista: document.getElementById('meta-meteo').value }, tramos: tramos }, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = document.getElementById('meta-nombre').value.replace(/ /g, '_') + ".json";
            a.click();
        }
    </script>
</body>
</html>